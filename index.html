<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>leastpass</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      background: #282828;
      margin: 1em;
    }

    input,
    select {
      font-family: sans-serif;
      font-size: x-large;
      border: none;
      padding: .2em;
      background: none;
      color: #ffb000;
      width: 100%;
      text-overflow: ellipsis;
    }

    input:focus, select:focus {
      background: whitesmoke;
      color: #282828;
    }

    button {
      margin: 1em 0;
      font-family: sans-serif;
      font-size: x-large;
      background: #ffb000;
      padding: .4em;
      box-shadow: 5px 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <form id="fields">
    <input type="text" id="site" placeholder="site">
    <input type="text" id="login" placeholder="login">
    <input type="password" id="master_password" type="password" placeholder="master password">
    <input type="text" id="alphabit" placeholder="alphabit">
    <input type="text" id="required_characters" placeholder="required one of">
    <select id="length">
      <option value="10">10 characters</option>
      <option value="20" selected>20 characters</option>
      <option value="30">30 characters</option>
      <option value="50">50 characters</option>
      <option value="100">100 characters</option>
    </select>
    <button>Copy password to clipboard</button>
  </form>

  <script>
    async function generate_password({
      master_password,
      site,
      login,
      alphabit,
      required,
      length
    }) {
      const enc = new TextEncoder('utf-8');

      for (let counter = 0; counter < 100; ++counter) {
        const encoded_fields = enc.encode([master_password, site, login, counter].join(':'));
        const digest = await crypto.subtle.digest('SHA-512', encoded_fields);
        const dv = new DataView(digest);
        const bits = Math.ceil(Math.log2(alphabit.length));
        const mask = (0x1 << bits) - 1;
        let password = '';
        let has_required = required.size === 0;

        attempt:
        for (let i = 0; i < dv.byteLength - 3; i += 4) {
          const d = dv.getUint32(i);
          for (let j = 0; j < (32 - bits); j += bits) {
            const offset = (d >> j) & mask;
            if (offset < alphabit.length) {
              const ch = alphabit[offset];
              password += ch;
              if (!has_required) {
                has_required = required.has(ch);
              }
              if (password.length >= length) {
                if (has_required) {
                  return password;
                } else {
                  break attempt;
                }
              }
            }
          }
        }
      }

      throw 'could not generate password';
    }

    function encode_site_url(fields) {
      const url = new URL(location.href);
      url.hash = `#${btoa(JSON.stringify(fields))}`;
      return url.href;
    }

    function decode_site_url() {
      const url = new URL(location.href);
      const s = url.hash.substr(1);
      return s.length > 0 ? JSON.parse(atob(s)) : {};
    }

    const site_el = document.getElementById('site'),
      login_el = document.getElementById('login'),
      master_password_el = document.getElementById('master_password'),
      length_el = document.getElementById('length'),
      alphabit_el = document.getElementById('alphabit'),
      required_characters_el = document.getElementById('required_characters'),
      fields_el = document.getElementById('fields');

    const fields = decode_site_url();

    site_el.value = fields.site || '';
    login_el.value = fields.login || '';
    alphabit_el.value = fields.alphabit || 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    required_characters_el.value = fields.required || '';
    length_el.value = fields.length || 20;

    fields_el.onchange = e => {
      if ([site_el, login_el, alphabit_el, alphabit_el, required_characters_el, length_el].indexOf(e.target) >= 0)
        location.href = encode_site_url({
          site: site_el.value,
          login: login_el.value,
          alphabit: alphabit_el.value,
          required: required_characters_el.value,
          length: length_el.value
        });
    };

    fields_el.onsubmit = async function () {
      try {
        navigator.clipboard.writeText(
          await generate_password({
            master_password: master_password_el.value,
            site: site_el.value,
            login: login_el.value,
            alphabit: alphabit_el.value,
            required: new Set(required_characters_el.value),
            length: length_el.value
          })
        );
      } catch (e) {
        console.log(e);
      }
    };
  </script>
</body>

</html>